<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Campus Safety App</title>
    <link href="../styles/output.css" rel="stylesheet" />
    <link href="../styles/styles.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../javascript/loadComponents.js" defer></script>
    <style>
        #map {
            height: 400px;
            width: 100%;
            display: none;
        }

        /* Loader styles */
        #mapLoader {
            display: none;
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>


<body class="flex flex-col min-h-screen bg-gray-100">
    <div id="header-placeholder"></div>
    <div class="flex flex-1">
        <div id="navbar-placeholder"></div>

        <!-- Main Content -->
        <main class="flex-1 p-6 overflow-auto">
            <div class="flex flex-col bg-gray-200 rounded-lg border border-gray-400 p-4 mx-20 max-sm:mx-0">
                <h2 class="text-center text-2xl font-bold mb-2 max-sm:text-xl">Incident Reporting</h2>
                <h3 class="text-center text-lg font-semibold mb-4 max-sm:text-sm">Report Incidents on campus for prompt
                    responses</h3>

                <form class="flex flex-col px-8 max-sm:px-4" action="">
                    <input class="p-2 rounded-xl mb-4 text-black max-sm:text-sm" type="text" placeholder="Title">

                    <select class="p-2 rounded-xl mb-4 bg-white max-sm:text-sm" name="incidentType" id="incidentType">
                        <option value="" selected>Incident Type</option>
                        <option value="theft">Theft</option>
                        <option value="assault">Assault</option>
                        <option value="harassment">Harassment</option>
                        <option value="vandalism">Vandalism</option>
                        <option value="other">Other</option>
                    </select>

                    <div class="flex justify-between items-center bg-white rounded-lg mb-4 max-sm:text-sm">
                        <label class="p-2" for="imageUpload">Upload Image</label>
                        <input type="file" id="imageUpload" name="imageUpload" accept="image/*" capture="environment">
                    </div>

                    <textarea class="p-2 rounded-lg mb-4 text-black max-sm:text-sm" placeholder="Description" rows="5"
                        id="description"></textarea>


                    <div class="bg-white mb-4 p-2 rounded-lg flex justify-between items-center max-sm:text-sm">
                        <div class="flex w-full items-center">
                            <label class="text-black whitespace-nowrap" for="location">Set Location:</label>
                            <input class="ml-2 rounded-lg text-black w-full" type="text" id="location"
                                placeholder="Select Location" readonly>
                        </div>
                        <img id="showMap" onclick="toggleMap()" class="w-7 h-7 cursor-pointer"
                            src="../assets/locationPick.png" alt="">
                    </div>

                    <!-- Loader and Map -->
                    <div class="mx-auto" id="mapLoader"></div> <!-- Loader -->
                    <div class="mb-2" id="map"></div> <!-- Map -->

                    <label class="max-sm:text-sm" for="incidentDate ">Select Incident Date:</label>
                    <input class="p-2 rounded-xl mb-4 text-black max-sm:text-sm" type="datetime-local"
                        id="incidentDateTime" name="incidentDateTime">
                    <button type="submit"
                        class="bg-[#015EB8] text-white py-2 px-4 rounded-lg max-sm:text-sm hover:opacity-80">Upload</button>
                </form>
            </div>
        </main>
    </div>
    <div id="footer-placeholder"></div>

    <script>
        let mapInitialized = false;

        function initMap() {
            navigator.geolocation.getCurrentPosition(function (position) {
                var currentLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                initializeMap(currentLocation);
            }, function () {
                var defaultLocation = { lat: -26.11, lng: 28.01 }; // Fallback location
                initializeMap(defaultLocation);
            });
        }

        function initializeMap(location) {
            if (mapInitialized) return; // Prevent reinitializing the map

            var map = new google.maps.Map(document.getElementById("map"), {
                zoom: 8,
                center: location
            });

            var marker = new google.maps.Marker({
                position: location,
                map: map,
                draggable: true
            });

            google.maps.event.addListener(marker, 'dragend', function (event) {
                document.getElementById('location').value = event.latLng.lat() + ', ' + event.latLng.lng();
            });

            google.maps.event.addListener(map, 'click', function (event) {
                marker.setPosition(event.latLng);
                document.getElementById('location').value = event.latLng.lat() + ', ' + event.latLng.lng();
            });

            mapInitialized = true; // Set the flag to true after initialization
        }

        function toggleMap() {

            var mapDiv = document.getElementById("map");
            var loader = document.getElementById("mapLoader");

            // Show loader while map is initializing
            loader.style.display = "block";
            mapDiv.style.display = "none";

            // Initialize map and show it after some delay (to simulate loading)
            setTimeout(function () {
                loader.style.display = "none";
                mapDiv.style.display = "block";
                //google.maps.event.trigger(map, "resize");
            }, 5000); // Simulate 5 seconds delay
        }

        // Initialize the map on page load, but keep it hidden
        window.onload = initMap;

    </script>

    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAmnz9yP1MewDeyOE-OV92JrAclq18JzZ4&loading=async&callback=initMap">
        </script>

</body>

</html>